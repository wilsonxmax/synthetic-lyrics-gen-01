name: Generate 10 Synthetic Songs (Bark)

on:
  workflow_dispatch:
    inputs:
      start_index:
        description: 'Starting song number'
        required: true
        default: '1'
      test_mode:
        description: 'Test mode (only 1 song)'
        required: false
        default: 'false'

jobs:
  generate-songs:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours for Bark (slower than mock)
    
    strategy:
      matrix:
        # Only generate 1 song for initial test
        song_index: [1]
        # After test succeeds, change to: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      
      fail-fast: false  # Continue other jobs if one fails
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # Use PyTorch 2.5 instead of 2.9 (avoids weights_only issues)
          pip install torch==2.5.1 torchaudio==2.5.1 --index-url https://download.pytorch.org/whl/cpu
          pip install numpy soundfile scipy librosa
          pip install git+https://github.com/suno-ai/bark.git
      
      - name: Create output directory
        run: mkdir -p outputs
      
      - name: Display system info
        run: |
          echo "=== SYSTEM INFO ==="
          python --version
          pip list | grep -E 'torch|bark|numpy'
          free -h
          df -h
          echo "==================="
      
      - name: Generate song ${{ matrix.song_index }} with Bark
        run: |
          python scripts/generate_song_bark.py \
            --index ${{ matrix.song_index }} \
            --output outputs/song_${{ matrix.song_index }}.mp3 \
            --timestamps outputs/song_${{ matrix.song_index }}.json
        timeout-minutes: 30  # 30 min max per song
      
      - name: Validate timestamps
        run: |
          python scripts/validate_timestamps.py \
            --audio outputs/song_${{ matrix.song_index }}.mp3 \
            --timestamps outputs/song_${{ matrix.song_index }}.json
      
      - name: Display generation stats
        run: |
          echo "=== GENERATION STATS ==="
          ls -lh outputs/
          if [ -f outputs/song_${{ matrix.song_index }}.json ]; then
            cat outputs/song_${{ matrix.song_index }}.json | python -m json.tool | head -30
          fi
          echo "========================"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if validation fails
        with:
          name: song-${{ matrix.song_index }}
          path: |
            outputs/song_${{ matrix.song_index }}.mp3
            outputs/song_${{ matrix.song_index }}.json
          retention-days: 30
